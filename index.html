<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RD2BOOKSHELF</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/style.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0B29XWKYNY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0B29XWKYNY');
    </script>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header" onclick="window.location.href='/'">
            <div class="sidebar-title"></div>
        </div>
        <div class="nav">
            <div class="nav-item" data-page="books">
                <i class="bi bi-book"></i>
                <span>书籍</span>
            </div>
            <div class="nav-item" data-page="favorites">
                <i class="bi bi-bookmarks"></i>
                <span>收藏</span>
            </div>
            <div class="nav-item" data-page="series">
                <i class="bi bi-collection"></i>
                <span>丛书</span>
            </div>
            <div class="nav-item" data-page="categories">
                <i class="bi bi-tags"></i>
                <span>分类</span>
            </div>
            <div class="nav-item" data-page="authors">
                <i class="bi bi-person-fill"></i>
                <span>作者</span>
            </div>
            <div class="nav-item" data-page="publishers">
                <i class="bi bi-shop-window"></i>
                <span>出版</span>
            </div>
            <div class="nav-item" data-page="languages">
                <i class="bi bi-translate"></i>
                <span>语言</span>
            </div>
        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="header">
            <div class="page-title">书籍</div>
            <div class="search-bar">
                <i class="bi bi-search"></i>
                <input type="text" placeholder="Search" id="search-input">
            </div>
        </div>

        <div class="content">
            <!-- 排序按钮，只在书籍页面显示 -->
            <div class="sort-buttons" id="sort-buttons">
                <button class="sort-button" data-sort="date-desc" title="添加时间倒序">
                    <i class="bi bi-clock-history"></i>
                    <i class="bi bi-sort-numeric-down-alt"></i>
                </button>
                <button class="sort-button" data-sort="date-asc" title="添加时间顺序">
                    <i class="bi bi-clock-history"></i>
                    <i class="bi bi-sort-numeric-down"></i>
                </button>
                <button class="sort-button" data-sort="title-asc" title="标题顺序">
                    <i class="bi bi-fonts"></i>
                    <i class="bi bi-sort-alpha-down"></i>
                </button>
                <button class="sort-button" data-sort="title-desc" title="标题倒序">
                    <i class="bi bi-fonts"></i>
                    <i class="bi bi-sort-alpha-down-alt"></i>
                </button>
                <button class="sort-button" data-sort="author-asc" title="作者顺序">
                    <i class="bi bi-person-fill"></i>
                    <i class="bi bi-sort-alpha-down"></i>
                </button>
                <button class="sort-button" data-sort="author-desc" title="作者倒序">
                    <i class="bi bi-person-fill"></i>
                    <i class="bi bi-sort-alpha-down-alt"></i>
                </button>
                <button class="sort-button" data-sort="pubdate-desc" title="出版日期倒序">
                    <i class="bi bi-calendar4-event"></i>
                    <i class="bi bi-sort-numeric-down-alt"></i>
                </button>
                <button class="sort-button" data-sort="pubdate-asc" title="出版日期顺序">
                    <i class="bi bi-calendar4-event"></i>
                    <i class="bi bi-sort-numeric-down"></i>
                </button>
                <button class="sort-button" data-sort="random" title="随机排序">
                    <i class="bi bi-shuffle"></i>
                </button>
            </div>

            <!-- 分类列表容器 -->
            <div class="books-grid" id="category-list" style="display: none;">
                <!-- 分类项将通过JavaScript动态加载 -->
            </div>
            
            <!-- 书籍网格 -->
            <div class="books-grid" id="books-container">
                <!-- 书籍将通过JavaScript动态加载 -->
            </div>
            
            <!-- 加载更多指示器 -->
            <div class="loading" id="loading-indicator" style="display: none;">
                <i class="bi bi-arrow-repeat"></i> 正在加载更多书籍...
            </div>
        </div>
        
        <!-- 关于按钮 -->
        <button class="about-button" id="about-button" onclick="showAboutModal()">
            <i class="bi bi-info-circle"></i>
        </button>
    </div>

    <!-- 书籍详情弹窗 -->
    <div class="modal-overlay" id="book-detail-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title" id="book-modal-title">书籍详情</div>
                <div class="modal-actions">
                    <button class="modal-action-button download-button" id="download-button" title="下载 EPUB">
                        <i class="bi bi-file-earmark-arrow-down"></i>
                    </button>
                    <button class="modal-action-button favorite-button" id="favorite-button" title="添加到收藏">
                        <i class="bi bi-bookmark-plus"></i>
                    </button>
                    <button class="modal-action-button read-button" id="read-button" title="阅读">
                        <i class="bi bi-book"></i>
                    </button>
                    <button class="modal-action-button close-button" onclick="closeBookDetail()" title="关闭">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <div class="book-detail-container" id="book-detail-container">
                <!-- 书籍详情将通过JavaScript动态加载 -->
            </div>
        </div>
    </div>
    
    <!-- 关于弹窗 -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">FROM RAINDROP213</div>
                <div class="modal-actions">
                    <button class="modal-action-button close-button" onclick="closeAboutModal()" title="关闭">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <div class="about-modal-container">
                <div class="about-content">
                    <h2>欢迎使用 RAINDROP213 书库项目</h2>
                    <p>本项目唯一站点为 <a href="http://ebook.raindrop213.com">ebook.raindrop213.com</a> 此外的站点均为盗链。
                        然后旧站点将继续保持推送，有需要的可以通过 <a href="http://calibre.raindrop213.com" target="_blank">calibre.raindrop213.com</a> 访问。
                        最后本站仅作为学习使用，不提供任何商业用途，感谢使用！</p>
                    <ul>
                        <li>使用了 <a href="https://github.com/satorumurmur/bibi" target="_blank">BiBi</a> 作为阅读器，一个非常棒的EPUB阅读器，感谢该项目作者的贡献</li>
                        <li>对比 <a href="https://github.com/janeczku/calibre-web" target="_blank">calibre-web</a> 搭建的旧站在移动端灾难级的表现，现在这个明显要好得多</li>
                        <li>WEB阅读器 <a href="https://reader.ttsu.app" target="_blank">ッツ</a> 和 <a href="/bibi/?book=" target="_blank">BiBi</a> 可以读取本地的EPUB电子书</li>
                        <li>界面设计来源于calibre-web中的黑暗模式</li>
                    </ul>
                    <div class="password-section">
                        <div class="password-input-group">
                            <input type="password" id="access-password" placeholder="输入访问码可开放更多书籍...">
                            <button onclick="submitPassword()">SAVE</button>
                        </div>
                        <div id="password-status" class="password-status"></div>
                    </div>
                    <div class="update-date">updata: 2025.03.18</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 当前页面和排序方式
        let currentPage = 1;
        let currentSort = 'date-desc'; // 默认按时间倒序排列
        let currentSection = 'books'; // 默认显示书籍页面
        let isLoading = false;
        let hasMoreBooks = true;
        
        // 分类加载相关变量
        let categoryPage = 1;
        let isLoadingCategories = false;
        let hasMoreCategories = true;
        let allCategoryItems = []; // 存储所有分类项
        
        // 当前分类信息
        let currentCategory = null;
        let currentCategoryType = null;
        
        // 收藏书籍数组
        let favoriteBooks = JSON.parse(localStorage.getItem('favoriteBooks')) || [];
        
        // 添加密码相关变量和函数
        let accessPassword = localStorage.getItem('accessPassword') || '';
        
        // 显示关于弹窗
        function showAboutModal() {
            const modal = document.getElementById('about-modal');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            document.querySelector('.main-content').classList.add('modal-open');
            document.querySelector('.content').classList.add('modal-open');
        }
        
        // 关闭关于弹窗
        function closeAboutModal() {
            const modal = document.getElementById('about-modal');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            document.querySelector('.main-content').classList.remove('modal-open');
            document.querySelector('.content').classList.remove('modal-open');
        }
        
        // 检查是否需要加载更多内容
        function checkNeedMoreContent() {
            const contentElement = document.querySelector('.content');
            
            // 如果当前是在书籍或者分类详情页面，且有更多书籍可加载
            if (!isLoading && hasMoreBooks && (currentSection === 'books' || currentCategory)) {
                // 如果内容没有出现滚动条，说明内容不足以填满视图区域
                if (contentElement.scrollHeight <= contentElement.clientHeight) {
                    currentPage++;
                    loadBooks();
                    return true;
                }
            }
            // 如果当前是在丛书列表页，且有更多丛书可加载
            else if (!isLoadingCategories && hasMoreCategories && currentSection === 'series' && !currentCategory) {
                // 如果内容没有出现滚动条，说明内容不足以填满视图区域
                if (contentElement.scrollHeight <= contentElement.clientHeight) {
                    categoryPage++;
                    loadCategories('series', categoryPage, true);
                    return true;
                }
            }
            return false;
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 监听popstate事件
            window.addEventListener('popstate', function(event) {
                const urlPath = window.location.pathname;
                handleUrlChange(urlPath);
            });

            // 初始化时根据当前URL路径加载内容
            const initialPath = window.location.pathname;
            handleUrlChange(initialPath);
            
            // 导航项点击事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    handleNavItemClick(page);
                });
            });
            
            // 排序按钮点击事件
            document.querySelectorAll('.sort-button').forEach(button => {
                button.addEventListener('click', function() {
                    const sort = this.getAttribute('data-sort');
                    if (sort !== currentSort) {
                        // 移除所有活动类
                        document.querySelectorAll('.sort-button').forEach(sortBtn => {
                            sortBtn.classList.remove('active');
                        });
                        
                        // 添加活动类到当前按钮
                        this.classList.add('active');
                        
                        // 更新当前排序并重置页面
                        currentSort = sort;
                        currentPage = 1;
                        hasMoreBooks = true;
                        
                        // 清空书籍容器
                        document.getElementById('books-container').innerHTML = '';
                        
                        // 重新加载书籍
                        loadBooks();
                    }
                });
            });
            
            // 搜索输入事件
            document.getElementById('search-input').addEventListener('input', debounce(function() {
                const searchQuery = this.value.trim();
                
                // 根据当前页面不同处理搜索
                if (currentSection === 'series' && !currentCategory) {
                    // 丛书列表页面搜索
                    categoryPage = 1;
                    hasMoreCategories = true;
                    document.getElementById('category-list').innerHTML = '';
                    
                    if (searchQuery) {
                        // 使用搜索API
                        fetch(`/api/series?search=${encodeURIComponent(searchQuery)}`)
                            .then(response => response.json())
                            .then(data => {
                                const items = data.series;
                                if (items.length > 0) {
                                    // 更新当前显示
                                    isLoadingCategories = false;
                                    hasMoreCategories = data.hasMore;
                                    
                                    // 渲染搜索结果
                                    const container = document.getElementById('category-list');
                                    items.forEach(item => {
                                        const categoryElement = document.createElement('div');
                                        categoryElement.className = 'book-card series-item';
                                        categoryElement.innerHTML = `
                                            ${item.cover_url 
                                                ? `<div class="cover-container">
                                                    <div class="book-count-badge">${item.book_count}</div>
                                                    <img src="${item.cover_url}?size=thumb" alt="${item.name}" class="book-cover" onload="this.classList.add('loaded')">
                                                  </div>`
                                                : `<div class="series-cover-placeholder">
                                                    <div class="book-count-badge">${item.book_count}</div>
                                                    <i class="bi bi-book"></i>
                                                  </div>`
                                            }
                                            <div class="series-info">
                                                <div class="book-title">${item.name}</div>
                                            </div>
                                        `;
                                        
                                        // 点击分类项显示相关书籍
                                        categoryElement.addEventListener('click', () => {
                                            currentCategory = item;
                                            currentCategoryType = 'series';
                                            showCategoryBooks(item.id, 'series');
                                        });
                                        
                                        container.appendChild(categoryElement);
                                    });
                                } else {
                                    document.getElementById('category-list').innerHTML = '<div class="no-results">没有找到匹配的丛书系列</div>';
                                }
                            })
                            .catch(error => {
                                console.error('搜索丛书时出错:', error);
                                document.getElementById('category-list').innerHTML = '<div class="error-message">搜索丛书时出错</div>';
                            });
                    } else {
                        // 如果搜索为空，重新加载全部丛书
                        loadCategories('series');
                    }
                } else {
                    // 书籍页面搜索
                    currentPage = 1;
                    hasMoreBooks = true;
                    document.getElementById('books-container').innerHTML = '';
                    loadBooks();
                }
            }, 500));
            
            // 滚动事件监听，实现无限滚动
            const contentElement = document.querySelector('.content');
            contentElement.addEventListener('scroll', function() {
                const scrollHeight = this.scrollHeight;
                const scrollTop = this.scrollTop;
                const clientHeight = this.clientHeight;
                const scrollThreshold = scrollHeight - 200;
                
                // 当滚动到内容底部附近时加载更多
                if (scrollTop + clientHeight >= scrollThreshold) {
                    // 书籍或分类详情页无限滚动
                    if ((currentSection === 'books' || currentSection === 'favorites' || currentCategory) && !isLoading && hasMoreBooks) {
                        currentPage++;
                        loadBooks();
                    }
                    // 丛书分类无限滚动
                    else if (currentSection === 'series' && !currentCategory && !isLoadingCategories && hasMoreCategories) {
                        categoryPage++;
                        loadCategories('series', categoryPage, true);
                    }
                }
            });
            
            // 监听窗口大小变化事件，当窗口大小变化时检查内容高度
            window.addEventListener('resize', debounce(checkNeedMoreContent, 200));
        });
        
        // 加载书籍函数
        function loadBooks() {
            if (isLoading || !hasMoreBooks) return;
            
            isLoading = true;
            document.getElementById('loading-indicator').style.display = 'block';
            
            // 获取搜索查询
            const searchQuery = document.getElementById('search-input').value.trim();
            
            // 构建API URL
            let apiUrl = `/api/books?page=${currentPage}&sort=${currentSort}&section=${currentSection}`;
            
            if (searchQuery) {
                apiUrl += `&search=${encodeURIComponent(searchQuery)}`;
            }
            
            // 添加分类过滤
            if (currentCategory && currentCategoryType) {
                switch (currentCategoryType) {
                    case 'publishers':
                        apiUrl += `&publishers=${currentCategory.id}`;
                        break;
                    case 'authors':
                        apiUrl += `&authors=${currentCategory.id}`;
                        break;
                    case 'categories':
                        apiUrl += `&categories=${currentCategory.id}`;
                        break;
                    case 'series':
                        apiUrl += `&series=${currentCategory.id}`;
                        break;
                    case 'languages':
                        apiUrl += `&languages=${currentCategory.id}`;
                        break;
                }
            }
            
            // 使用新的fetchWithPassword函数
            fetchWithPassword(apiUrl)
                .then(response => response.json())
                .then(data => {
                    isLoading = false;
                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    if (data.books && data.books.length > 0) {
                        // 渲染书籍
                        renderBooks(data.books);
                        
                        // 检查是否还有更多书籍
                        hasMoreBooks = data.hasMore;
                        
                        // 检查内容高度是否小于视图区域高度，如果是且还有更多书籍，则自动加载更多
                        setTimeout(() => {
                            checkNeedMoreContent();
                        }, 200); // 给渲染一些时间
                    } else {
                        hasMoreBooks = false;
                        if (currentPage === 1) {
                            document.getElementById('books-container').innerHTML = '<div class="no-results">没有找到书籍</div>';
                        }
                    }
                })
                .catch(error => {
                    console.error('加载书籍时出错:', error);
                    isLoading = false;
                    document.getElementById('loading-indicator').style.display = 'none';
                });
        }
        
        // 渲染书籍函数
        function renderBooks(books) {
            const container = document.getElementById('books-container');
            
            books.forEach(book => {
                // 为封面URL添加缩略图参数
                const coverUrl = book.cover_url ? `${book.cover_url}?size=thumb` : '/images/loading.svg';
                
                // 判断是否为系列书籍且有系列号
                const isSeriesBook = currentCategoryType === 'series' && book.series_index;
                
                const bookElement = document.createElement('div');
                bookElement.className = 'book-card';
                bookElement.innerHTML = `
                    <div class="cover-container clickable">
                        ${isSeriesBook ? `<div class="series-index-badge">${formatSeriesIndex(book.series_index)}</div>` : ''}
                        <img src="${coverUrl}" alt="${book.title}" class="book-cover" onload="this.classList.add('loaded')">
                    </div>
                    <div class="book-info">
                        <div class="book-title" onclick="showBookDetail(${book.id})">${book.title}</div>
                        <div class="book-author">${formatAuthorLinks(book.author)}</div>
                    </div>
                `;
                
                // 点击书籍封面或标题查看详情
                bookElement.querySelectorAll('.clickable').forEach(element => {
                    element.addEventListener('click', function(event) {
                        event.stopPropagation(); // 阻止事件冒泡
                        showBookDetail(book.id);
                    });
                });
                
                container.appendChild(bookElement);
            });
        }
        
        // 格式化系列号
        function formatSeriesIndex(seriesIndex) {
            if (seriesIndex === null || seriesIndex === undefined) return '';
            
            // 确保系列号为数字类型
            const numIndex = parseFloat(seriesIndex);
            if (isNaN(numIndex)) return seriesIndex.toString();
            
            // 如果是整数，不显示小数部分
            return Number.isInteger(numIndex) ? numIndex.toString() : numIndex.toFixed(1);
        }
        
        // 格式化作者链接
        function formatAuthorLinks(author) {
            if (!author) return '';
            // 如果作者是数组，处理多个作者
            if (Array.isArray(author)) {
                return author.map(a => `<a href="/authors/${encodeURIComponent(a)}">${a}</a>`).join('；');
            }
            // 单个作者
            return `<a href="/authors/${encodeURIComponent(author)}">${author}</a>`;
        }
        
        // 格式化标签链接
        function formatTagLinks(tags) {
            if (!tags || tags.length === 0) return '无';
            return tags.map(tag => 
                `<span class="tag" onclick="window.location.href='/categories/${encodeURIComponent(tag)}'">
                    ${tag}
                </span>`
            ).join(' ');
        }
        
        // 格式化标识符信息
        function formatIdentifiers(identifiers) {
            if (!identifiers || Object.keys(identifiers).length === 0) return '无';
            
            // 标识符类型的友好显示名称
            const idTypeNames = {
                'isbn': 'ISBN',
                'google': 'Google',
                'mobi-asin': 'MOBI',
                'amazon': 'Amazon',
                'amazon_jp': 'Amazon'
            };
            
            // 为不同类型的标识符生成不同的链接
            const createIdentifierTag = (type, value) => {
                const className = `identifier ${type.toLowerCase()}`;
                
                // 根据不同类型生成不同的链接URL
                let url = '';
                switch(type) {
                    case 'isbn':
                        url = `https://www.worldcat.org/isbn/${encodeURIComponent(value)}`;
                        break;
                    case 'google':
                        url = `https://books.google.com/books?id=${encodeURIComponent(value)}`;
                        break;
                    case 'amazon':
                        url = `https://www.amazon.co.jp/dp/${encodeURIComponent(value)}`;
                        break;
                    case 'mobi-asin':
                        url = `https://www.amazon.co.jp/dp/${encodeURIComponent(value)}`;
                        break;
                    case 'amazon_jp':
                        url = `https://www.amazon.co.jp/dp/${encodeURIComponent(value)}`;
                        break;
                    default:
                        url = '#';
                        break;
                }
                
                const displayName = idTypeNames[type] || type;
                // return `<a href="${url}" class="${className}" target="_blank">${displayName}</a>`;
                return `<span class="${className}" onclick="window.open('${url}', '_blank')">${displayName}</span>`;
            };
            
            // 生成所有标识符标签
            return Object.entries(identifiers).map(([type, value]) => {
                return createIdentifierTag(type, value);
            }).join(' ');
        }
        
        // 显示书籍详情
        function showBookDetail(bookId) {
            // 显示弹窗
            const modal = document.getElementById('book-detail-modal');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            document.querySelector('.main-content').classList.add('modal-open');
            document.querySelector('.content').classList.add('modal-open');
            
            // 加载书籍详情
            fetchWithPassword(`/api/books/${bookId}`)
                .then(response => response.json())
                .then(book => {
                    // 设置弹窗标题
                    document.getElementById('book-modal-title').textContent = book.title;
                    
                    // 设置下载和阅读按钮的链接
                    const downloadButton = document.getElementById('download-button');
                    const readButton = document.getElementById('read-button');
                    const favoriteButton = document.getElementById('favorite-button');
                    
                    // 检查是否已收藏
                    const isFavorite = favoriteBooks.some(favBook => favBook.id === book.id);
                    if (isFavorite) {
                        favoriteButton.innerHTML = '<i class="bi bi-bookmark-check-fill"></i>';
                        favoriteButton.title = '取消收藏';
                    } else {
                        favoriteButton.innerHTML = '<i class="bi bi-bookmark-plus"></i>';
                        favoriteButton.title = '收藏';
                    }
                    
                    // 设置收藏按钮点击事件
                    favoriteButton.onclick = function() {
                        toggleFavorite(book);
                    };
                    
                    downloadButton.onclick = function() {
                        window.location.href = book.epub_url;
                    };
                    
                    // 设置下载按钮的自定义文件名提示
                    let customFilename = '';
                    if (book.authors && book.authors.length > 0) {
                        customFilename = `[${book.authors.join('×')}] ${book.title}.epub`;
                    } else {
                        customFilename = `${book.title}.epub`;
                    }
                    // 替换文件名中的非法字符
                    customFilename = customFilename
                        .replace(/[\/\\:*?"<>|]/g, '_') // 替换Windows和Unix系统中的非法字符
                        .replace(/\s+/g, ' '); // 将多个空格替换为单个空格
                    
                    downloadButton.title = `下载 ${customFilename}`;
                    
                    readButton.onclick = function() {
                        window.location.href = `/bibi/?book=${encodeURIComponent(book.path + '/' + book.epub_file)}`;
                    };
                    
                    const container = document.getElementById('book-detail-container');
                    
                    // 格式化日期
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '未知';
                        const date = new Date(dateStr);
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        return `${year}年${month}月${day}日`;
                    };
                    
                    // 格式化详情页面的作者链接
                    function formatDetailAuthorLinks(authors) {
                        if (!authors) return '';
                        // 如果作者是数组，处理多个作者
                        if (Array.isArray(authors)) {
                            return authors.map(a => `<a href="/authors/${encodeURIComponent(a)}">${a}</a>`).join('；');
                        }
                        // 单个作者
                        return `<a href="/authors/${encodeURIComponent(authors)}">${authors}</a>`;
                    }
                    
                    // 构建HTML
                    container.innerHTML = `
                        <div class="book-detail-layout">
                            <div class="book-detail-cover">
                                <div class="cover-container" id="detail-cover-container">
                                    <img src="${book.cover_url || '/images/loading.svg'}" alt="${book.title}" class="detail-cover-img" onload="this.classList.add('loaded')">
                                </div>
                            </div>
                            <div class="book-detail-info">
                                <div class="book-detail-header">
                                    <h1 class="detail-title">${book.title}</h1>
                                    <div class="detail-author">${formatDetailAuthorLinks(book.authors)}</div>
                                </div>
                                <div class="detail-meta">
                                    ${book.series ? `
                                    <div class="meta-item">
                                        <span class="meta-label">系列</span>
                                        <span class="meta-value">
                                            <a href="/series/${encodeURIComponent(book.series)}">${book.series}</a>
                                            ${book.series_index ? ` ${formatSeriesIndex(book.series_index)}` : ''}
                                        </span>
                                    </div>
                                    ` : ''}
                                    ${book.publisher ? `
                                    <div class="meta-item">
                                        <span class="meta-label">出版商</span>
                                        <span class="meta-value">
                                            <a href="/publishers/${encodeURIComponent(book.publisher)}">${book.publisher}</a>
                                        </span>
                                    </div>
                                    ` : ''}
                                    <div class="meta-item">
                                        <span class="meta-label">出版日</span>
                                        <span class="meta-value">${formatDate(book.pubdate)}</span>
                                    </div>
                                    ${book.identifiers && Object.keys(book.identifiers).length > 0 ? `
                                    <div class="meta-item">
                                        <span class="meta-label">标识符</span>
                                        <span class="meta-value">${formatIdentifiers(book.identifiers)}</span>
                                    </div>
                                    ` : ''}
                                    <div class="meta-item">
                                        <span class="meta-label">标签</span>
                                        <span class="meta-value">${formatTagLinks(book.tags)}</span>
                                    </div>
                                </div>
                                ${book.comment ? `
                                <div class="detail-description">
                                    <div class="description-content">${book.comment}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    // 为封面添加点击事件，打开阅读器
                    document.getElementById('detail-cover-container').addEventListener('click', function() {
                        window.location.href = `/bibi/?book=${encodeURIComponent(book.path + '/' + book.epub_file)}`;
                    });
                })
                .catch(error => {
                    console.error('加载书籍详情时出错:', error);
                    document.getElementById('book-detail-container').innerHTML = `
                        <div class="error-message">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>加载书籍详情时出错</p>
                            <button class="retry-button" onclick="showBookDetail(${bookId})">重试</button>
                        </div>
                    `;
                });
        }
        
        // 关闭书籍详情弹窗
        function closeBookDetail() {
            const modal = document.getElementById('book-detail-modal');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            document.querySelector('.main-content').classList.remove('modal-open');
            document.querySelector('.content').classList.remove('modal-open');
        }
        
        // 点击弹窗背景关闭弹窗
        document.getElementById('book-detail-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeBookDetail();
            }
        });
        
        // 添加关于弹窗背景点击关闭事件
        document.getElementById('about-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeAboutModal();
            }
        });
        
        // 添加ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeBookDetail();
                closeAboutModal();
            }
        });
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // 加载分类列表
        function loadCategories(type, page = 1, append = false) {
            if (isLoadingCategories && append) return;
            
            isLoadingCategories = true;
            
            if (append) {
                // 显示加载指示器
                if (document.getElementById('category-loading-indicator')) {
                    document.getElementById('category-loading-indicator').style.display = 'block';
                }
            } else {
                document.getElementById('category-list').style.display = 'grid';
                document.getElementById('books-container').style.display = 'none';
                document.getElementById('sort-buttons').style.display = 'none';
                
                // 确保加载指示器存在
                if (!document.getElementById('category-loading-indicator')) {
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'loading';
                    loadingIndicator.id = 'category-loading-indicator';
                    loadingIndicator.innerHTML = '<i class="bi bi-arrow-repeat"></i> 正在加载更多...';
                    document.querySelector('.content').appendChild(loadingIndicator);
                }
                
                // 更新页面标题
                const typeNames = {
                    'publishers': '出版',
                    'authors': '作者',
                    'categories': '分类',
                    'series': '丛书',
                    'languages': '语言'
                };
                
                document.querySelector('.page-title').textContent = typeNames[type];
                
                // 更新URL
                history.pushState(null, null, `/${type}`);
                
                // 清空当前分类
                currentCategory = null;
                currentCategoryType = null;
                categoryPage = 1;
                hasMoreCategories = true;
                allCategoryItems = [];
                
                // 清空分类列表
                document.getElementById('category-list').innerHTML = '';
            }
            
            // 构建API URL
            const apiUrl = `/api/${type}${type === 'series' ? `?page=${page}` : ''}`;
            
            fetchWithPassword(apiUrl)
                .then(response => response.json())
                .then(data => {
                    isLoadingCategories = false;
                    document.getElementById('category-loading-indicator').style.display = 'none';
                    
                    const container = document.getElementById('category-list');
                    const items = data[type];
                    
                    // 对于丛书，使用服务器返回的分页信息
                    if (type === 'series') {
                        hasMoreCategories = data.hasMore;
                        categoryPage = data.page;
                    } else {
                        allCategoryItems = items; // 存储所有项目
                    }
                    
                    items.forEach(item => {
                        const categoryElement = document.createElement('div');
                        if (type === 'series') {
                            categoryElement.className = 'book-card series-item';
                            // 丛书项的特殊显示
                            categoryElement.innerHTML = `
                                ${item.cover_url 
                                    ? `<div class="cover-container">
                                        <div class="book-count-badge">${item.book_count}</div>
                                        <img src="${item.cover_url}?size=thumb" alt="${item.name}" class="book-cover" onload="this.classList.add('loaded')">
                                      </div>`
                                    : `<div class="series-cover-placeholder">
                                        <div class="book-count-badge">${item.book_count}</div>
                                        <i class="bi bi-book"></i>
                                      </div>`
                                }
                                <div class="series-info">
                                    <div class="book-title">${item.name}</div>
                                </div>
                            `;
                        } else {
                            categoryElement.className = 'category-item';
                            // 其他分类的普通显示
                            categoryElement.innerHTML = `
                                <div class="category-name">${item.name}</div>
                                <div class="category-count">× ${item.book_count}</div>
                            `;
                        }
                        
                        // 点击分类项显示相关书籍
                        categoryElement.addEventListener('click', () => {
                            currentCategory = item;
                            currentCategoryType = type;
                            showCategoryBooks(item.id, type);
                        });
                        
                        container.appendChild(categoryElement);
                    });
                    
                    // 检查是否需要加载更多内容
                    setTimeout(() => {
                        checkNeedMoreContent();
                    }, 200);
                })
                .catch(error => {
                    console.error(`加载${type}列表时出错:`, error);
                    isLoadingCategories = false;
                    if (document.getElementById('category-loading-indicator')) {
                        document.getElementById('category-loading-indicator').style.display = 'none';
                    }
                    
                    if (!append) {
                        document.getElementById('category-list').innerHTML = `
                            <div class="error-message">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>加载分类列表时出错</p>
                                <button class="retry-button" onclick="loadCategories('${type}')">重试</button>
                            </div>
                        `;
                    }
                });
        }
        
        // 显示分类相关的书籍
        function showCategoryBooks(categoryId, type) {
            document.getElementById('category-list').style.display = 'none';
            document.getElementById('books-container').style.display = 'grid';
            document.getElementById('sort-buttons').style.display = 'none';
            
            // 更新页面标题
            const categoryName = currentCategory.name;
            const typeNames = {
                'publishers': '出版',
                'authors': '作者',
                'categories': '分类',
                'series': '丛书',
                'languages': '语言'
            };

            document.querySelector('.page-title').innerHTML = `
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="loadCategories('${type}')">${typeNames[type]}</span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-current">${categoryName}</span>
                </div>
            `;
            
            // 更新 URL
            history.pushState(null, null, `/${type}/${encodeURIComponent(categoryName)}`);
            
            // 重置分页并加载书籍
            currentPage = 1;
            hasMoreBooks = true;
            document.getElementById('books-container').innerHTML = '';
            loadBooks();
        }
        
        // 切换收藏状态
        function toggleFavorite(book) {
            const favoriteButton = document.getElementById('favorite-button');
            const index = favoriteBooks.findIndex(favBook => favBook.id === book.id);
            
            if (index === -1) {
                // 添加到收藏
                const bookToSave = {
                    id: book.id,
                    title: book.title,
                    author: book.authors,
                    cover_url: book.cover_url,
                    date_added: new Date().toISOString()
                };
                favoriteBooks.push(bookToSave);
                favoriteButton.innerHTML = '<i class="bi bi-bookmark-check-fill"></i>';
                favoriteButton.title = '取消收藏';
            } else {
                // 从收藏中移除
                favoriteBooks.splice(index, 1);
                favoriteButton.innerHTML = '<i class="bi bi-bookmark-plus"></i>';
                favoriteButton.title = '收藏';
            }
            
            // 保存到本地存储
            localStorage.setItem('favoriteBooks', JSON.stringify(favoriteBooks));
            
            // 如果当前在收藏页面，刷新显示
            if (currentSection === 'favorites') {
                loadFavoriteBooks();
            }
        }
        
        // 清理内容窗口的函数
        function clearContentWindow() {
            // 清空书籍容器
            document.getElementById('books-container').innerHTML = '';
            // 隐藏分类列表
            document.getElementById('category-list').style.display = 'none';
            // 显示书籍容器
            document.getElementById('books-container').style.display = 'grid';
            // 隐藏排序按钮
            document.getElementById('sort-buttons').style.display = 'none';
            // 隐藏加载指示器
            document.getElementById('loading-indicator').style.display = 'none';
            
            // 移除分类加载指示器（如果存在）
            const categoryLoadingIndicator = document.getElementById('category-loading-indicator');
            if (categoryLoadingIndicator) {
                categoryLoadingIndicator.remove();
            }
        }

        // 导航项点击事件处理函数
        function handleNavItemClick(page) {
            if (page !== currentSection) {
                // 先清理内容窗口
                clearContentWindow();
                
                // 移除所有活动类
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                
                // 添加活动类到当前项
                document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
                
                // 更新当前部分
                currentSection = page;
                currentPage = 1; // 重置页码为1
                hasMoreBooks = true; // 默认允许无限滚动
                currentCategory = null;
                currentCategoryType = null;
                
                // 重置分类页码
                if (page === 'series' || page === 'categories' || page === 'publishers' || page === 'authors' || page === 'languages') {
                    categoryPage = 1;
                    hasMoreCategories = true;
                }
                
                // 更新页面标题
                const typeNames = {
                    'publishers': '出版',
                    'authors': '作者',
                    'categories': '分类',
                    'series': '丛书',
                    'languages': '语言',
                    'books': '书籍',
                    'favorites': '收藏'
                };
                document.querySelector('.page-title').textContent = typeNames[page];
                
                // 只有当URL需要更新时才调用pushState
                if (window.location.pathname !== `/${page}`) {
                    history.pushState(null, null, `/${page}`);
                }
                
                // 根据页面类型显示不同内容
                if (['publishers', 'authors', 'categories', 'series', 'languages'].includes(page)) {
                    loadCategories(page);
                } else if (page === 'books') {
                    // 如果是books页面，默认激活date-desc排序按钮
                    document.getElementById('sort-buttons').style.display = 'flex';
                    document.querySelectorAll('.sort-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector('.sort-button[data-sort="date-desc"]').classList.add('active');
                    currentSort = 'date-desc';
                    loadBooks();
                } else if (page === 'favorites') {
                    // 如果是收藏页面，显示收藏的书籍
                    loadFavoriteBooks();
                } else {
                    loadBooks();
                }
            }
        }

        // 加载收藏的书籍
        function loadFavoriteBooks() {
            // 确保先清理内容窗口
            clearContentWindow();
            
            // 强制重置状态
            currentSection = 'favorites';
            currentPage = 1;
            hasMoreBooks = false; // 收藏页面不需要无限滚动
            currentCategory = null;
            currentCategoryType = null;
            
            // 确保URL是正确的
            if (window.location.pathname !== '/favorites') {
                history.replaceState(null, null, '/favorites');
            }
            
            // 确保导航项高亮正确
            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.classList.remove('active');
            });
            document.querySelector('.nav-item[data-page="favorites"]').classList.add('active');
            
            const container = document.getElementById('books-container');
            
            if (favoriteBooks.length === 0) {
                container.innerHTML = '<div class="no-results">请在书籍信息页的右上角点击收藏</div>';
                return;
            }
            
            // 按添加时间倒序排列
            const sortedBooks = [...favoriteBooks].sort((a, b) => {
                return new Date(b.date_added) - new Date(a.date_added);
            });
            
            // 渲染收藏的书籍
            renderBooks(sortedBooks);
        }

        // 根据URL路径更新页面内容的函数
        function handleUrlChange(urlPath) {
            // 检查URL是否包含分类信息
            const categoryMatch = urlPath.match(/^\/([a-z]+)\/([^\/]+)$/);
            if (categoryMatch) {
                const [, type, categoryName] = categoryMatch;
                if (['publishers', 'authors', 'categories', 'series', 'languages'].includes(type)) {
                    currentSection = type;
                    const navItem = document.querySelector(`.nav-item[data-page="${type}"]`);
                    if (navItem) {
                        document.querySelectorAll('.nav-item').forEach(navItem => {
                            navItem.classList.remove('active');
                        });
                        navItem.classList.add('active');
                        
                        // 先显示列表加载状态
                        document.getElementById('category-list').style.display = 'grid';
                        document.getElementById('books-container').style.display = 'none';
                        document.getElementById('sort-buttons').style.display = 'none';
                        document.getElementById('category-list').innerHTML = '<div class="loading">加载中...</div>';
                        
                        // 记录页面标题
                        const typeNames = {
                            'publishers': '出版',
                            'authors': '作者',
                            'categories': '分类',
                            'series': '丛书',
                            'languages': '语言'
                        };
                        document.querySelector('.page-title').textContent = typeNames[type];
                        
                        // 先加载分类列表
                        if (type === 'series') {
                            // 对于系列，使用专门的API直接通过名称查找
                            fetchWithPassword(`/api/series?name=${categoryName}`)
                                .then(response => {
                                    if (!response.ok) {
                                        if (response.status === 404) {
                                            throw new Error('未找到系列');
                                        }
                                        throw new Error('获取系列信息失败');
                                    }
                                    return response.json();
                                })
                                .then(category => {
                                    console.log('找到匹配的系列:', category);
                                    currentCategory = category;
                                    currentCategoryType = type;
                                    showCategoryBooks(category.id, type);
                                })
                                .catch(error => {
                                    console.error(`通过名称查找系列时出错:`, error);
                                    // 没有找到匹配项，显示完整列表
                                    document.getElementById('category-list').innerHTML = '';
                                    loadCategories(type);
                                });
                        } else {
                            // 对于其他分类类型，使用原有的方法
                            fetchWithPassword(`/api/${type}`)
                                .then(response => response.json())
                                .then(data => {
                                    const items = data[type];
                                    console.log(`获取到${type}列表:`, items.length, '项');
                                    
                                    // 不区分大小写查找匹配项
                                    const decodedName = decodeURIComponent(categoryName).toLowerCase();
                                    const category = items.find(item => 
                                        item.name.toLowerCase() === decodedName
                                    );
                                    
                                    if (category) {
                                        console.log('找到匹配的分类:', category);
                                        currentCategory = category;
                                        currentCategoryType = type;
                                        showCategoryBooks(category.id, type);
                                    } else {
                                        console.log('未找到匹配的分类');
                                        // 没有找到匹配项，显示完整列表
                                        document.getElementById('category-list').innerHTML = '';
                                        loadCategories(type);
                                    }
                                })
                                .catch(error => {
                                    console.error(`加载${type}列表时出错:`, error);
                                    document.getElementById('category-list').innerHTML = 
                                        `<div class="error-message">加载${typeNames[type]}列表时出错</div>`;
                                });
                        }
                    }
                }
            } else {
                const bookMatch = urlPath.match(/\/book\/(\d+)/);
                if (bookMatch) {
                    const bookId = parseInt(bookMatch[1]);
                    showBookDetail(bookId);
                } else {
                    const sectionMatch = urlPath.match(/^\/([a-z]+)/);
                    if (sectionMatch) {
                        const sectionFromUrl = sectionMatch[1];
                        if (['publishers', 'authors', 'categories', 'series', 'languages', 'books', 'favorites'].includes(sectionFromUrl)) {
                            currentSection = sectionFromUrl;
                            const navItem = document.querySelector(`.nav-item[data-page="${sectionFromUrl}"]`);
                            if (navItem) {
                                document.querySelectorAll('.nav-item').forEach(navItem => {
                                    navItem.classList.remove('active');
                                });
                                navItem.classList.add('active');
                                const typeNames = {
                                    'publishers': '出版',
                                    'authors': '作者',
                                    'categories': '分类',
                                    'series': '丛书',
                                    'languages': '语言',
                                    'books': '书籍',
                                    'favorites': '收藏'
                                };
                                document.querySelector('.page-title').textContent = typeNames[sectionFromUrl] || navItem.querySelector('span').textContent;
                                if (['publishers', 'authors', 'categories', 'series', 'languages'].includes(sectionFromUrl)) {
                                    loadCategories(sectionFromUrl);
                                } else {
                                    document.getElementById('category-list').style.display = 'none';
                                    document.getElementById('books-container').style.display = 'grid';
                                    document.getElementById('sort-buttons').style.display = sectionFromUrl === 'books' ? 'flex' : 'none';
                                    document.getElementById('books-container').innerHTML = '';
                                    if (sectionFromUrl === 'books') {
                                        document.querySelectorAll('.sort-button').forEach(btn => {
                                            btn.classList.remove('active');
                                        });
                                        document.querySelector('.sort-button[data-sort="date-desc"]').classList.add('active');
                                        currentSort = 'date-desc';
                                    }
                                    if (sectionFromUrl === 'favorites') {
                                        loadFavoriteBooks();
                                    } else {
                                        loadBooks();
                                    }
                                }
                            }
                        }
                    } else {
                        document.querySelector(`.nav-item[data-page="${currentSection}"]`).classList.add('active');
                        document.querySelector(`.sort-button[data-sort="${currentSort}"]`).classList.add('active');
                        loadBooks();
                    }
                }
            }
        }

        // 提交密码
        function submitPassword() {
            const passwordInput = document.getElementById('access-password');
            const passwordStatus = document.getElementById('password-status');
            const newPassword = passwordInput.value.trim();
            
            // 保存密码到本地存储
            localStorage.setItem('accessPassword', newPassword);
            accessPassword = newPassword;
            
            // 显示状态
            passwordStatus.textContent = '访问码已保存 √';
            passwordStatus.className = 'password-status success';
            
            // 清空输入框
            passwordInput.value = '';
            
            setTimeout(() => {
                passwordStatus.textContent = '';
                passwordStatus.className = 'password-status';
            }, 1500);
            
            // 刷新当前页面内容
            if (currentSection === 'books') {
                currentPage = 1;
                hasMoreBooks = true;
                document.getElementById('books-container').innerHTML = '';
                loadBooks();
            } else if (['publishers', 'authors', 'categories', 'series', 'languages'].includes(currentSection)) {
                loadCategories(currentSection);
            }
        }

        // 修改所有API请求，添加密码头
        function addPasswordHeader(headers = {}) {
            if (accessPassword) {
                headers['X-Access-Password'] = accessPassword;
            }
            return headers;
        }

        // 修改fetch调用，添加密码头
        function fetchWithPassword(url, options = {}) {
            options.headers = addPasswordHeader(options.headers || {});
            return fetch(url, options);
        }
    </script>
</body>
</html>
